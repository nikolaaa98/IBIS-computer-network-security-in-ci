<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>IBIS Demo UI</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; background: #f5f5f5; }
    .card { border: 1px solid #ddd; padding: 18px; border-radius: 8px; margin-bottom: 16px; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .big { font-size: 2.2rem; font-weight: bold; }
    pre { background:#111; color:#fff; padding:12px; max-height: 400px; overflow:auto; font-family: 'Monaco', 'Menlo', monospace; border-radius: 6px; }
    .btn { padding:10px 16px; border-radius:6px; text-decoration:none; color:white; background:#007acc; display:inline-block; border: none; cursor: pointer; margin: 4px; font-size: 14px; transition: all 0.3s; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-danger { background:#d9534f; }
    .btn-success { background:#5cb85c; }
    .btn-warning { background:#f0ad4e; }
    .btn-secondary { background:#6c757d; }
    .btn-info { background:#17a2b8; }
    .value-row { margin-bottom: 12px; padding: 8px; border-radius: 6px; background: #f8f9fa; }
    .status { padding: 6px 12px; border-radius: 6px; font-weight: bold; font-size: 12px; }
    .status-running { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-stopped { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status-alert { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .attack-controls { display: flex; flex-wrap: wrap; gap: 10px; margin: 12px 0; }
    .service-controls { margin: 12px 0; display: flex; flex-wrap: wrap; gap: 10px; }
    .log-entry { margin: 4px 0; padding: 4px 8px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; }
    .timestamp { color: #888; font-size: 11px; }
    .attack-active { background: #f8d7da !important; color: #721c24 !important; border-left: 4px solid #d9534f; }
    .defense-active { background: #d1ecf1 !important; color: #0c5460 !important; border-left: 4px solid #17a2b8; }
    .alert-critical { background: #f8d7da; color: #721c24; border: 2px solid #d9534f; padding: 12px; border-radius: 6px; margin: 8px 0; }
    .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; padding: 10px; border-radius: 6px; margin: 6px 0; }
    .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 10px; border-radius: 6px; margin: 6px 0; }
    .system-health { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin: 12px 0; }
    .health-item { padding: 10px; border-radius: 6px; background: #f8f9fa; text-align: center; }
    .attack-effect { background: #fff3cd; padding: 10px; border-radius: 6px; margin: 8px 0; border-left: 4px solid #f0ad4e; }
    .defense-action { background: #d4edda; padding: 10px; border-radius: 6px; margin: 8px 0; border-left: 4px solid #5cb85c; }
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 6px; color: white; z-index: 1000; opacity: 0.95; }
    .notification-success { background: #5cb85c; }
    .notification-error { background: #d9534f; }
    .notification-warning { background: #f0ad4e; }
    .hidden { display: none; }
    h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    h3 { color: #34495e; margin-top: 0; }
    .attack-description { font-size: 12px; color: #666; margin-top: 4px; }
    .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
    .server-values { background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50; }
    .client-values { background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3; }
    .value-comparison { display: flex; justify-content: space-between; margin: 8px 0; padding: 8px; background: white; border-radius: 6px; }
    .difference { font-weight: bold; padding: 2px 8px; border-radius: 4px; }
    .difference-positive { background: #ffebee; color: #c62828; }
    .difference-negative { background: #e8f5e8; color: #2e7d32; }
    .manipulation-alert { background: #fff3cd; border: 2px solid #ff9800; padding: 10px; border-radius: 6px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>üõ°Ô∏è IBIS ‚Äî Industrial Control System Security Demo</h1>

  <!-- Notification Area -->
  <div id="notification" class="notification hidden"></div>

  <!-- System Health -->
  <div class="card">
    <h3>üìä System Health Monitor</h3>
    <div class="system-health">
      <div class="health-item">
        <div>Modbus Server</div>
        <div class="status status-stopped" id="server-status">STOPPED</div>
      </div>
      <div class="health-item">
        <div>Modbus Client</div>
        <div class="status status-stopped" id="client-status">STOPPED</div>
      </div>
      <div class="health-item">
        <div>MITM Proxy</div>
        <div class="status status-stopped" id="proxy-status">STOPPED</div>
      </div>
      <div class="health-item">
        <div>Defense System</div>
        <div class="status status-stopped" id="defense-status">STOPPED</div>
      </div>
    </div>
  </div>

  <!-- Service Controls -->
  <div class="card">
    <h3>‚öôÔ∏è Service Controls</h3>
    <div class="service-controls">
      <button class="btn btn-success" onclick="startServices()">‚ñ∂Ô∏è Pokreni Sve Servise</button>
      <button class="btn btn-danger" onclick="stopServices()">‚èπÔ∏è Zaustavi Sve Servise</button>
      <button class="btn btn-info" id="defense-btn" onclick="toggleDefense()">üõ°Ô∏è Pokreni Defense Sistem</button>
      <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
    </div>
  </div>

  <!-- Current Values Comparison -->
  <div class="card">
    <h3>üìä Real-time Value Comparison</h3>
    
    <div id="manipulation-alert" class="manipulation-alert hidden">
      ‚ö†Ô∏è <strong>MANIPULATION DETECTED!</strong> Client values are different from server values!
    </div>
    
    <div class="comparison-grid">
      <!-- Server Values -->
      <div class="server-values">
        <h4>üîß Server Values (Real)</h4>
        <div id="server-values">
          <div class="value-comparison">
            <span>Temperatura:</span>
            <span id="server-temp">-- ¬∞C</span>
          </div>
          <div class="value-comparison">
            <span>Vla≈ænost:</span>
            <span id="server-humidity">-- %</span>
          </div>
          <div class="value-comparison">
            <span>Pritisak:</span>
            <span id="server-pressure">-- hPa</span>
          </div>
        </div>
      </div>
      
      <!-- Client Values -->
      <div class="client-values">
        <h4>üìä Client Values (What HMI Sees)</h4>
        <div id="client-values">
          <div class="value-comparison">
            <span>Temperatura:</span>
            <span id="client-temp">-- ¬∞C</span>
            <span id="temp-diff" class="difference"></span>
          </div>
          <div class="value-comparison">
            <span>Vla≈ænost:</span>
            <span id="client-humidity">-- %</span>
            <span id="humidity-diff" class="difference"></span>
          </div>
          <div class="value-comparison">
            <span>Pritisak:</span>
            <span id="client-pressure">-- hPa</span>
            <span id="pressure-diff" class="difference"></span>
          </div>
        </div>
      </div>
    </div>
    
    <div id="comparison-summary" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
      <strong>Status:</strong> <span id="comparison-status">Loading...</span>
    </div>
  </div>

  <!-- MITM Controls -->
  <div class="card">
    <h3>üîÑ MITM Manipulacija Podacima</h3>
    <p>Trenutno: <strong id="manipulate-status" style="color: {% if control.manipulate %}#d9534f{% else %}#5cb85c{% endif %}">
      {{ 'ON üü¢' if control.manipulate else 'OFF üî¥' }}
    </strong></p>
    <button class="btn {{ 'btn-danger' if control.manipulate else 'btn-success' }}" onclick="toggleManipulation()">
      {{ 'üî¥ Disable Manipulation' if control.manipulate else 'üü¢ Enable Manipulation' }}
    </button>
    <p><small>Kada je ON, proxy poveƒáava temperaturu za 10¬∞C, vla≈ænost za 5%, pritisak za 20hPa</small></p>
  </div>

  <!-- Attack Controls -->
  <div class="card">
    <h3>üéØ Simulacija Napada</h3>
    <div class="attack-controls">
      <button class="btn btn-warning" onclick="startAttack('recon')">üîç Recon Scan</button>
      <button class="btn btn-warning" onclick="startAttack('dos')">üí• DoS Attack</button>
      <button class="btn btn-danger" onclick="startAttack('inject')">üíâ Command Injection</button>
      <button class="btn btn-danger" onclick="startAttack('all')">‚ö° Full Attack Chain</button>
      <button class="btn btn-secondary" onclick="stopAttacks()">‚èπÔ∏è Stop All Attacks</button>
    </div>
    <div id="attack-status">
      <p><strong>Active Attacks:</strong> <span id="active-attacks">None</span></p>
      <div id="attack-effects"></div>
    </div>
  </div>

  <!-- Attack Alerts -->
  <div class="card">
    <h3>üö® Attack Alerts & Defense Actions</h3>
    <div id="attack-alerts">
      {% if attack_alerts %}
        {% for alert in attack_alerts %}
          <div class="alert-{{ 'critical' if 'BLOCKED' in alert.message else 'warning' }}">
            <strong>{{ alert.timestamp.split('T')[1][:8] }}</strong> - 
            {{ alert.message | safe }}
          </div>
        {% endfor %}
      {% else %}
        <div class="alert-info">No attack alerts detected</div>
      {% endif %}
    </div>
  </div>

  <!-- Manual Write -->
  <div class="card">
    <h3>‚úèÔ∏è Ruƒçno Upisivanje Vrednosti</h3>
    <form id="write-form" onsubmit="writeValues(event)">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
          <label>Temperatura (0-100¬∞C):</label><br>
          <input name="temp" type="number" min="0" max="100" style="width: 100%; padding: 8px; margin: 4px 0;"/>
        </div>
        <div>
          <label>Vla≈ænost (0-100%):</label><br>
          <input name="humidity" type="number" min="0" max="100" style="width: 100%; padding: 8px; margin: 4px 0;"/>
        </div>
        <div>
          <label>Pritisak (900-1100hPa):</label><br>
          <input name="pressure" type="number" min="900" max="1100" style="width: 100%; padding: 8px; margin: 4px 0;"/>
        </div>
        <div style="display: flex; align-items: end;">
          <button class="btn btn-secondary" type="submit" style="width: 100%;">üìù Write Values</button>
        </div>
      </div>
      <input type="hidden" name="host" value="{{ proxy_host }}"/>
      <input type="hidden" name="port" value="{{ proxy_port }}"/>
    </form>
  </div>

  <!-- Defense Information -->
  <div class="card">
    <h3>üõ°Ô∏è Defense System Information</h3>
    <p><strong>Monitoring:</strong> Modbus TCP traffic on port 8502</p>
    <p><strong>Detection Capabilities:</strong></p>
    <ul>
      <li>‚úÖ Malicious function codes detection</li>
      <li>‚úÖ Rapid request attacks blocking</li>
      <li>‚úÖ Malformed packets filtering</li>
      <li>‚úÖ Connection flooding prevention</li>
      <li>‚úÖ Suspicious payload patterns detection</li>
      <li>‚úÖ Automatic IP blocking (5 minutes)</li>
    </ul>
    <p><strong>Current Status:</strong> 
      <span id="defense-info" class="status {{ 'status-running' if defense_enabled else 'status-stopped' }}">
        {{ 'ACTIVE üõ°Ô∏è' if defense_enabled else 'INACTIVE ‚ö†Ô∏è' }}
      </span>
    </p>
  </div>

  <!-- Live Logs -->
  <div class="card">
    <h3>üìã Live Logs 
      <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Clear</button>
      <button class="btn btn-info" onclick="toggleAutoRefresh()" id="auto-refresh-btn">üîÑ Auto-Refresh: ON</button>
    </h3>
    <pre id="logs">{% for log in logs %}{{ log | safe }}
{% endfor %}</pre>
  </div>

  <script>
    let autoRefresh = true;
    let attackEffects = {
      'recon': 'üîç Scanning network for vulnerable registers...',
      'dos': 'üí• Flooding server with requests - may cause timeouts...', 
      'inject': 'üíâ Injecting malicious commands - sensor values may change...',
      'all': '‚ö° Full attack chain - system under heavy load...'
    };

    // Auto-refresh intervals
    setInterval(updateValues, 2000);
    setInterval(updateLogs, 3000);
    setInterval(updateServiceStatus, 5000);
    setInterval(updateAttackAlerts, 4000);

    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification notification-${type}`;
      notification.classList.remove('hidden');
      
      setTimeout(() => {
        notification.classList.add('hidden');
      }, 3000);
    }

    async function updateValues() {
      try {
        const response = await fetch('/api/values');
        const data = await response.json();
        
        if (data.values) {
          const server = data.values.server;
          const client = data.values.client;
          
          // Update server values
          document.getElementById('server-temp').textContent = server.temperature + ' ¬∞C';
          document.getElementById('server-humidity').textContent = server.humidity + ' %';
          document.getElementById('server-pressure').textContent = server.pressure + ' hPa';
          
          // Update client values
          document.getElementById('client-temp').textContent = client.temperature + ' ¬∞C';
          document.getElementById('client-humidity').textContent = client.humidity + ' %';
          document.getElementById('client-pressure').textContent = client.pressure + ' hPa';
          
          // Calculate and show differences
          updateDifferences(server, client);
          
          // Show manipulation alert
          const manipulationAlert = document.getElementById('manipulation-alert');
          if (data.manipulation_detected) {
            manipulationAlert.classList.remove('hidden');
          } else {
            manipulationAlert.classList.add('hidden');
          }
          
          // Update comparison status
          const statusElement = document.getElementById('comparison-status');
          if (data.manipulation_detected) {
            statusElement.innerHTML = '‚ö†Ô∏è <span style="color: #d9534f;">Data manipulation detected!</span>';
          } else if (data.control.manipulate) {
            statusElement.innerHTML = 'üîÑ <span style="color: #f0ad4e;">MITM manipulation enabled</span>';
          } else {
            statusElement.innerHTML = '‚úÖ <span style="color: #5cb85c;">Values synchronized</span>';
          }
        }
        
        // Update manipulation status
        if (data.control) {
          const statusElem = document.querySelector('#manipulate-status');
          if (statusElem) {
            statusElem.innerText = data.control.manipulate ? 'ON üü¢' : 'OFF üî¥';
            statusElem.style.color = data.control.manipulate ? '#d9534f' : '#5cb85c';
          }
        }
      } catch (error) {
        console.log('Error updating values:', error);
      }
    }

    function updateDifferences(server, client) {
      // Temperature difference
      const tempDiff = client.temperature - server.temperature;
      const tempDiffElement = document.getElementById('temp-diff');
      tempDiffElement.textContent = (tempDiff > 0 ? '+' : '') + tempDiff + '¬∞C';
      tempDiffElement.className = `difference ${tempDiff !== 0 ? 'difference-positive' : ''}`;
      
      // Humidity difference
      const humidityDiff = client.humidity - server.humidity;
      const humidityDiffElement = document.getElementById('humidity-diff');
      humidityDiffElement.textContent = (humidityDiff > 0 ? '+' : '') + humidityDiff + '%';
      humidityDiffElement.className = `difference ${humidityDiff !== 0 ? 'difference-positive' : ''}`;
      
      // Pressure difference
      const pressureDiff = client.pressure - server.pressure;
      const pressureDiffElement = document.getElementById('pressure-diff');
      pressureDiffElement.textContent = (pressureDiff > 0 ? '+' : '') + pressureDiff + 'hPa';
      pressureDiffElement.className = `difference ${pressureDiff !== 0 ? 'difference-positive' : ''}`;
    }

    async function updateLogs() {
      if (!autoRefresh) return;
      
      try {
        const response = await fetch('/api/logs');
        const data = await response.json();
        const logsElement = document.getElementById('logs');
        if (logsElement && data.logs) {
          logsElement.innerHTML = data.logs.join('\n');
          logsElement.scrollTop = logsElement.scrollHeight;
        }
      } catch (error) {
        console.log('Error updating logs:', error);
      }
    }

    async function updateAttackAlerts() {
      try {
        const response = await fetch('/api/attack-alerts');
        const data = await response.json();
        const alertsElement = document.getElementById('attack-alerts');
        
        if (alertsElement && data.alerts) {
          alertsElement.innerHTML = data.alerts.map(alert => {
            const isCritical = alert.message && (
              alert.message.includes('BLOCKED') || 
              alert.message.includes('üö®') ||
              alert.message.includes('MALICIOUS')
            );
            const alertClass = isCritical ? 'alert-critical' : 'alert-warning';
            const timestamp = alert.timestamp ? alert.timestamp.split('T')[1].substring(0, 8) : '--:--:--';
            const message = alert.message || JSON.stringify(alert);
            
            return `<div class="${alertClass}">
              <strong>${timestamp}</strong> - ${message}
            </div>`;
          }).join('');
        }
      } catch (error) {
        console.log('Error updating attack alerts:', error);
      }
    }

    async function updateServiceStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        updateStatusElement('server-status', data.server);
        updateStatusElement('client-status', data.client);
        updateStatusElement('proxy-status', data.proxy);
        updateStatusElement('defense-status', data.defense);
        
        // Update active attacks
        const activeAttacksElement = document.getElementById('active-attacks');
        const attackEffectsElement = document.getElementById('attack-effects');
        
        if (data.attacks && data.attacks.length > 0) {
          const active = data.attacks.filter(a => a.active);
          activeAttacksElement.innerHTML = active.map(a => 
            `<span class="status status-alert">${a.type} (${a.duration})</span>`
          ).join(' ');
          
          // Show attack effects
          attackEffectsElement.innerHTML = active.map(a => 
            `<div class="attack-effect">${attackEffects[a.type] || 'Attack in progress...'}</div>`
          ).join('');
        } else {
          activeAttacksElement.innerHTML = 'None';
          attackEffectsElement.innerHTML = '';
        }
        
        // Update defense info
        const defenseInfo = document.getElementById('defense-info');
        if (defenseInfo) {
          defenseInfo.innerText = data.defense ? 'ACTIVE üõ°Ô∏è' : 'INACTIVE ‚ö†Ô∏è';
          defenseInfo.className = `status ${data.defense ? 'status-running' : 'status-stopped'}`;
        }
        
        // Update defense button
        const defenseBtn = document.getElementById('defense-btn');
        if (defenseBtn) {
          defenseBtn.innerText = data.defense ? 'üõë Zaustavi Defense Sistem' : 'üõ°Ô∏è Pokreni Defense Sistem';
          defenseBtn.className = data.defense ? 'btn btn-warning' : 'btn btn-info';
        }
        
      } catch (error) {
        console.log('Error updating status:', error);
      }
    }

    function updateStatusElement(elementId, isRunning) {
      const element = document.getElementById(elementId);
      if (element) {
        element.innerText = isRunning ? 'RUNNING ‚úÖ' : 'STOPPED ‚ùå';
        element.className = `status ${isRunning ? 'status-running' : 'status-stopped'}`;
      }
    }

    async function startServices() {
      try {
        const response = await fetch('/api/start-services', { method: 'POST' });
        const result = await response.json();
        showNotification(result.message || 'Services started', 'success');
        updateServiceStatus();
      } catch (error) {
        showNotification('Error starting services', 'error');
      }
    }

    async function stopServices() {
      try {
        const response = await fetch('/api/stop-services', { method: 'POST' });
        const result = await response.json();
        showNotification(result.message || 'Services stopped', 'success');
        updateServiceStatus();
      } catch (error) {
        showNotification('Error stopping services', 'error');
      }
    }

    async function startAttack(type) {
      try {
        const response = await fetch('/api/start-attack', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: type })
        });
        const result = await response.json();
        showNotification(result.message || `Attack ${type} started`, 'warning');
        updateServiceStatus();
      } catch (error) {
        showNotification('Error starting attack', 'error');
      }
    }

    async function stopAttacks() {
      try {
        const response = await fetch('/api/stop-attacks', { method: 'POST' });
        const result = await response.json();
        showNotification(result.message || 'All attacks stopped', 'success');
        updateServiceStatus();
      } catch (error) {
        showNotification('Error stopping attacks', 'error');
      }
    }

    async function toggleDefense() {
      try {
        const response = await fetch('/api/toggle-defense', { method: 'POST' });
        const result = await response.json();
        if (result.success) {
          showNotification(result.message, 'success');
          updateServiceStatus();
        } else {
          showNotification('Error: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showNotification('Error toggling defense system', 'error');
      }
    }

    async function toggleManipulation() {
      try {
        const response = await fetch('/toggle', { method: 'POST' });
        if (response.ok) {
          showNotification(`Data manipulation toggled`, 'success');
          updateValues();
        }
      } catch (error) {
        showNotification('Error toggling manipulation', 'error');
      }
    }

    async function writeValues(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      
      try {
        const response = await fetch('/write', {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        
        if (result.success) {
          showNotification(result.message, 'success');
          event.target.reset();
        } else {
          showNotification(result.message, 'error');
        }
      } catch (error) {
        showNotification('Error writing values', 'error');
      }
    }

    async function clearLogs() {
      try {
        const response = await fetch('/api/clear-logs', { method: 'POST' });
        const result = await response.json();
        if (result.success) {
          showNotification('Logs cleared', 'success');
          updateLogs();
        }
      } catch (error) {
        showNotification('Error clearing logs', 'error');
      }
    }

    function toggleAutoRefresh() {
      autoRefresh = !autoRefresh;
      const btn = document.getElementById('auto-refresh-btn');
      btn.textContent = `üîÑ Auto-Refresh: ${autoRefresh ? 'ON' : 'OFF'}`;
      btn.className = `btn ${autoRefresh ? 'btn-info' : 'btn-secondary'}`;
    }

    // Initial load
    updateValues();
    updateServiceStatus();
    updateAttackAlerts();
  </script>
</body>
</html>